# --- OpenAPI 3.1: Screen 4 – Conversation Setup ---

paths:
  /v1/situations:suggest:
    post:
      tags: [Conversations]
      summary: Generate a free-text conversation situation suggestion
      operationId: suggestSituation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SuggestSituationRequest"
      responses:
        "200":
          description: Suggested situation text.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuggestSituationResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/ServerError"

  /v1/conversations/{conversation_id}/setup:
    get:
      tags: [Conversations]
      summary: Get conversation setup
      operationId: getConversationSetup
      parameters:
        - $ref: "#/components/parameters/ConversationId"
      responses:
        "200":
          description: Conversation setup.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationSetup"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

    patch:
      tags: [Conversations]
      summary: Update conversation setup
      operationId: updateConversationSetup
      parameters:
        - $ref: "#/components/parameters/ConversationId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConversationSetupPatch"
      responses:
        "200":
          description: Updated conversation setup.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationSetup"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/ServerError"

components:
  schemas:
    # -----------------------------
    # Situation suggestion (LLM)
    # -----------------------------
    SuggestSituationRequest:
      type: object
      required: [formality]
      additionalProperties: false
      properties:
        formality:
          type: string
          enum: [formal, informal]
          description: Desired formality level for the suggested situation.

    SuggestSituationResponse:
      type: object
      required: [text]
      additionalProperties: false
      properties:
        text:
          type: string
          maxLength: 300
          description: >
            LLM-generated free-text description of a conversation situation
            (e.g., "interaction with a cashier in a store").

    # -----------------------------
    # Conversation setup (session intent)
    # -----------------------------
    ConversationSetup:
      type: object
      required:
        - formality
        - situation
        - initiator
        - grammar_focus
      additionalProperties: false
      properties:
        formality:
          type: string
          enum: [formal, informal]
          description: Formality level for this conversation.
        situation:
          type: string
          maxLength: 500
          description: Free-text description of the conversation situation.
        initiator:
          type: string
          enum: [system, user]
          description: Who initiates the conversation.
        grammar_focus:
          type: array
          minItems: 0
          maxItems: 30
          description: Grammar constructions to focus on during this conversation.
          items:
            $ref: "#/components/schemas/GrammarTarget"

    ConversationSetupPatch:
      type: object
      additionalProperties: false
      properties:
        formality:
          type: string
          enum: [formal, informal]
        situation:
          type: string
          maxLength: 500
        initiator:
          type: string
          enum: [system, user]
        grammar_focus:
          type: array
          minItems: 0
          maxItems: 30
          items:
            $ref: "#/components/schemas/GrammarTarget"

    # -----------------------------
    # Grammar target (catalog reference)
    # -----------------------------
    GrammarTarget:
      type: object
      required: [id, label]
      additionalProperties: false
      properties:
        id:
          type: string
          format: uuid
          description: Internal grammar identifier.
        label:
          type: string
          description: Human-readable grammar label (e.g., "て形").
        description:
          type: string
          description: Short explanation of the grammar point.
